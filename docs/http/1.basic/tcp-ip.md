---
title: TCP/IP协议
sidebar_label: TCP/IP协议
---

import Img from '../../../src/components/Img'

## 前言
TCP/IP 协议实际上是一系列网络通信协议的统称，其中最核心的两个协议是TCP和IP，其他的还有 UDP、ICMP、ARP 等等，共同构成了一个复杂但有层次的协议栈。

<Img width="480" legend="图：TCP/IP协议簇" src="https://cosmos-x.oss-cn-hangzhou.aliyuncs.com/3YA6IN.png" />

HTTP 是一个"传输协议"，但它不关心寻址、路由、数据完整性等传输细节，而要求这些工作都由下层来处理。因为TCP/IP 协议刚好满足 HTTP 的要求，所以互联网上的 HTTP 协议就运行在了 TCP/IP 上。

## IP和TCP协议

### 协议
计算机与网络设备要相互通信，双方就必须基于相同的方法。比如，如何探测到通信目标、由哪一边先发起通信、使用哪种语言进行通信、怎样结束通信等规则都需要事先确定。不同的硬件、操作系统之间的通信，所有的这一切都需要一种规则。而我们就把这种规则称为协议( protocol)。

### IP协议
IP 协议是**Internet Protocol** 的缩写，主要目的是解决寻址和路由问题，以及如何在两点间传送数据包。IP 协议使用**IP 地址**的概念来定位互联网上的每一台计算机。可以对比一下现实中的电话系统，你拿着的手机相当于互联网上的计算机，而要打电话就必须接入电话网，由通信公司给你分配一个号码，这个号码就相当于 IP 地址。

### TCP协议
TCP 协议是**Transmission Control Protocol**的缩写，意思是 **传输控制协议**，它位于 IP 协议之上，基于 IP 协议提供可靠的、字节流形式的通信，是 HTTP 协议得以实现的基础。

**可靠**是指保证数据不丢失，**字节流**是指保证数据完整，所以在 TCP 协议的两端可以如同操作文件一样访问传输的数据，就像是读写在一个密闭的管道里**流动**的字节。

## DNS
在 TCP/IP 协议中使用 IP 地址来标识计算机，数字形式的地址对于计算机来说是方便了，但对于人类来说却既难以记忆又难以输入。

可以想一下我们使用手机打电话，如果让我们每次打电话都要输入电话号码显然是令人不爽的。所以一般我们都会把朋友的手机号和姓名存储在通讯录中，然后找到姓名就可以直接拨打电话了。那么这里的姓名就对应着**域名**，而电话号码对应的就是**IP**，而解析这层映射就是**DNS**要做的工作。

### DNS解析

- 浏览器缓存：浏览器会按照一定的频率缓存 DNS 记录。
- 操作系统缓存：如果浏览器缓存中找不到需要的 DNS 记录，那就去操作系统中找。
- 路由缓存：路由器也有 DNS 缓存。
- 局部 DNS 服务器：如果在通过以上操作仍然拿不到域名对应的IP地址，客户端就会询问向局部 DNS服务器，如果仍然没有搜索到，就将根域名服务器地址发送给客户端。
- 根服务器：局部 DNS 服务器还找不到的话，它就会向根服务器发出请求，进行递归或者迭代查询。

递归或者迭代查询各级服务器的过程和区别可以查看这篇文章：[DNS解析过程原理](https://juejin.im/post/5b0a32a36fb9a07ab979f0b4)

## TCP/IP协议分层

TCP/IP协议簇里的层次划分为链路层、传输层、网络层和应用层。TCP/IP协议的四层就像搭积木一样，每一层需要下层的支撑，同时又支撑着上层，任何一层被抽掉都可能会导致整个协议栈坍塌。同时分层也使得各层只考虑分配给自己的任务，而不需要关心其他层的具体实现。

<Img width="360" legend="图：TCP/IP协议簇" src="https://cosmos-x.oss-cn-hangzhou.aliyuncs.com/jv7Caj.png" />

- 链路层（link layer）负责在**以太网、WiFi 这样的底层网络上发送原始数据包**，工作在网卡这个层次，使用**MAC地址**来标记网络上的设备，所以有时候也叫MAC层。

- 网络层（internet layer），IP 协议就处在这一层。因为 IP 协议定义了**IP 地址**的概念，所以就可以在链路层的基础上，**用 IP 地址取代 MAC 地址**，把许许多多的**局域网、广域网连接成一个虚拟的巨大网络**，在这个网络里找网络上的设备时只要把 IP 地址再“翻译”成 MAC 地址就可以了。

- 传输层（transport layer），这个层次协议的职责是保证数据在**IP 地址标记的两点之间可靠地传输**，是 TCP 和 UDP 协议工作的层次。

- 应用层（application layer），应用层有各种面向具体应用的协议。HTTP层属于该层，还有其他协议例如 Telnet、SSH、FTP、SMTP 等等。

## OSI 网络分层模型

OSI，全称是**开放式系统互联通信参考模型**（Open System Interconnection Reference Model）。由于TCP/IP 的概念出现于 1970 年代，当时除了它还有很多其他的网络协议，整个网络世界比较混乱，所以而国际标准组织（ISO）为了统一既存的各种网络协议设计了该模型。

OSI一共分为7层，并为每层设计了编号，具体如下图所示：

<Img width="360" legend="图：OSI分层模型图" src="https://cosmos-x.oss-cn-hangzhou.aliyuncs.com/mhBFCr.png" />

- 第一层：物理层，网络的物理形式，例如电缆、光纤、网卡、集线器等等；
- 第二层：数据链路层，它基本相当于 TCP/IP 的链路层；
- 第三层：网络层，相当于 TCP/IP 里的网络层；
- 第四层：传输层，相当于 TCP/IP 里的传输层；
- 第五层：会话层，维护网络中的连接状态，即保持会话和同步；
- 第六层：表示层，把数据转换为合适、可理解的语法和语义；
- 第七层：应用层，面向具体的应用传输数据。

由于TCP/IP 等协议已经在许多网络上实际运行，所以将他们全部推翻重构显然是不现实的。此外，OSI的分层模型在四层以上分的太细，而 TCP/IP实际应用时的会话管理、编码转换、压缩等和具体应用经常联系的很紧密，很难分开。例如，HTTP 协议就同时包含了连接管理和数据格式定义。因此，OSI分层模型在发布的时候就明确地表明只是作为一个**参考**。

### TCP/IP 和 OSI分层的映射关系

现在我们有了两个网络分层模型：TCP/IP 和 OSI，新的问题又出现了，一个是四层模型，一个是七层模型，这两者应该如何互相映射呢？

<Img width="540" legend="图：OSI分层模型图" src="https://cosmos-x.oss-cn-hangzhou.aliyuncs.com/yfEQMV.png" />

通过上图，我们可以得到如下结论：

- 第一层：物理层，TCP/IP分层里没有；
- 第二层：数据链路层，对应 TCP/IP 的链路层；
- 第三层：网络层，对应 TCP/IP 的网络层；
- 第四层：传输层，对应 TCP/IP 的传输层；
- 第五、六、七层：统一对应到 TCP/IP 的应用层。

通过两者的映射关系可以看出，TCP/IP 是一个**纯软件的栈**，没有网络应有的最根基的电缆、网卡等物理设备的位置。而 OSI 则补足了这个缺失，**在理论层面上**描述网络更加完整。


## TCP/IP 协议栈的工作方式

TCP/IP 协议栈的工作方式，可以用HTTP来举个例子：

1. 客户端如果要获得Web页面的资源，可以在应用层发出一个HTTP请求。

2. 为了传输方便，在传输层(TCP 协议)把从**应用层处收到的数据(HTTP 请求报文)进行分割**，并在各个报文段上打上**标记序号和端口号**，然后将报文转发给网络层。

3. 在网络层(IP协议)，为数据添加IP头信息生成数据包，并将这些包路由转发给链路层。

4. 链路层为数据包添加MAC头，然后组装成帧并将数据传输给服务器。

5. 接收端的服务器在链路层接收到数据，按序往上层发送，一直到应用层。当传输到应用层，才能算真正接收到由客户端发送过来的HTTP请求。

<Img width="360" legend="图：TCP/IP协议簇" src="https://cosmos-x.oss-cn-hangzhou.aliyuncs.com/iAUBTu.png" />

发送端在层与层之间传输数据时，每经过一层时必定会被打上一个该层所属的首部信息。反之，接收端在层与层传输数据时，每经过一层时会把对应的首部消去。如下图所示：

<Img width="360" legend="图：TCP/IP协议簇" src="https://cosmos-x.oss-cn-hangzhou.aliyuncs.com/w0KyOo.png" />

## 小结

本文整理了一些HTTP相关的基础知识，但是对于其中的细节并没有展开，如果对于文中具体的知识点感兴趣，可以去网上搜索相关的知识点进行学习。