---
title: Advanced Query
---

In this section, you will learn SQL clause as follows:

- AVG
- COUNT
- MAX
- MIN
- SUM
- ROUND
- GROUP BY
- HAVING
- ORDER BY

Example: _user_profile_

| id  | device_id | gender | age | university          | gpa |
| --- | --------- | ------ | --- | ------------------- | --- |
| 1   | 2138      | male   | 21  | Peking University   | 3.4 |
| 2   | 3214      | male   |     | Fudan University    | 4.0 |
| 3   | 6543      | female | 20  | Peking University   | 3.2 |
| 4   | 2315      | female | 23  | Zhejiang University | 3.6 |
| 5   | 5432      | male   | 25  | Shandong University | 3.8 |

## Aggregates

在工作场景中，我们经常需要对数据进行一些汇总计算而不是查询明细值，为此 SQL 提供了专门的函数，这节我们来介绍一下常见的计算函数。

### AVG

AVG()为平均值函数，通过对表中行数计数并计算其列值之和，求得该列的平均值。 AVG() 可用来返回所有列的平均值，也可以用来返回特定列或行的平均值。下面的例子 返回的是 `user_profile` 表中所有用户的平均 gpa 情况 。

```sql
Select avg(gpa)
From user_profile
```

### COUNT

COUNT()函数为计数函数，可利用 COUNT()确定表中行的数目或符合特定 条件的行的数目。

COUNT()函数有两种使用方式：

- 使用 `COUNT(*)` 对表中行的数目进行计数，不管表列中包含的是空值（NULL）还是非空值。
- 使用 `COUNT(column)` 对特定列中具有值的行进行计数，忽略 NULL 值。

这两点该怎么理解呢，比如对于下面的数据表，如果用语法 1，那么得到的结果会是 5，因为表中一共有 5 行数据

Syntax 1:

```sql
SELECT COUNT(*) AS num_cnt FROM user_profile;
```

| num_cnt |
| ------- |
| 5       |

但如果我们对 age 列进行 count，因为该列中存在一行为空值，在计数中不会被算入，语法 2 得到的结果会是 4

Syntax 2:

```sql
SELECT COUNT(age) AS num_cnt FROM user_profile;
```

| num_cnt |
| ------- |
| 4       |

### MAX

MAX()返回指定列中的最大值。MAX 在使用时，（）需指定要返回最大值的列名，语法如下所示：

```sql
SELECT MAX(age) AS max_age FROM user_profile;
```

这里，MAX()返回 user_profile 表中最大的年龄取值

### MIN

MIN()的功能正好与 MAX()功能相反，它返回指定列的最小值。与 MAX() 一样，MIN() 要求指定列名，如下所示：

```sql
SELECT MIN(age) AS min_age FROM user_profile;
```

### SUM

SUM()用来返回指定列值的和（总计）。如下所示函数返回了 age 列所有用户年纪的总和

```sql
SELECT SUM(age) AS sum_age FROM user_profile;
```

### ROUND

在一些聚集运算中，容易出现结果为非整数的情况，这时候如果想要限定结果返回的小数位数就可以使用 SQL 中内置的 round 函数，语法格式为 round（value，n），其中 value 代表想要限制小数位数的字段，n 代表想要限制的小数位数。下列语句就代表求 age 列的均值，并保留一位小数。

```sql
SELECT round(avg(age),1) AS avg_age FROM user_profile;
```

## Groups of Rows

分组查询数据涉及到两个新 SELECT 语句子句：`GROUP BY` 子句和 `HAVING` 子句。 In the previous section, we have known how to use SQL 聚集函数汇总数据，但之前的计算中都是对于表的所有数据或匹配特定的 WHERE 子句的数据中进行，比如计算复旦大学学生的平均 gpa 情况，但如果我们想要返回每个学校的分别的平均 gpa 情况，应该怎么做呢？这时候就需要用到本章节要讲的分组语句。

### 分组计算

理解分组语句最好的办法是从例子出发，我们来看一个例子：

```sql
SELECT university, avg(gpa) AS avg_gpa
FROM user_profile
GROUP BY university
```

Output:

| university          | avg_gpa |
| ------------------- | ------- |
| Peking University   | 3.3     |
| Fudan University    | 3.65    |
| Shandong University | 3.65    |
| Zhejiang University | 3.6     |

示例的 SELECT 语句指定了两个列：university 为用户的学校， avg(gpa)为计算字段，代表平均 gpa。 GROUP BY 子句指示 SQL 按 university 分组分别计算每个学校的平均 gpa 情况，从输出中可以看到，结果返回了每个大学的平均 gpa 数值。在使用 GROUP BY 时，有一些事项需要注意：

1. GROUP BY 子句可以包含任意数目的列，因而可以对分组进行嵌套，更细致地进行数据分组。
2. 除聚集计算语句外，SELECT 语句中的每一列都必须在 GROUP BY 子句中同时给出。
3. 如果分组列中包含具有 NULL 值的行，则 NULL 将作为一个分组返回。 如果列中有多行 NULL 值，它们将分为一组。
4. GROUP BY 子句必须出现在 WHERE 子句之后，ORDER BY 子句之前。

### 分组过滤

除了能用 GROUP BY 分组数据外，SQL 还允许在分组的结果下进行过滤，**分组查询的结果不能简单的使用 WHERE 语句进行过滤，而需要使用专门的 HAVING 语句**。在上一章节题目中，我们计算了不同性别和不同学校分组下的用户 30 天内平均活跃天数情况，假如说我们只想要取出平均活跃天数在 10 天以上的分组，这时就可以用到 HAVING 语句，来看示例：

```sql
SELECT
    gender,
    university,
    count(device_id) AS user_num,
    avg(active_days_within_30) AS avg_active_days,
    avg(question_cnt) AS avg_question_cnt
FROM user_profile
GROUP BY gender, university
HAVING avg(active_days_within_30) > 10
```

Output:

| gender | university          | user_num | avg_active_days | avg_question_cnt |
| ------ | ------------------- | -------- | --------------- | ---------------- |
| female | Peking University   | 1        | 12              | 3                |
| male   | Fudan University    | 1        | 15              | 5                |
| male   | Shandong University | 2        | 17.5            | 11               |

可以看到，这条 SELECT 语句中除最后一行外其他语法与上一道题完全一致。在最后一行中我们增加了 HAVING 子句，并搭配使用了 `avg(active_days_within_30) > 10` 的条件，这种最终结果中就只会返回 30 天平均活跃天数大于 10 的分组。

<Img w="750" src='https://cosmos-x.oss-cn-hangzhou.aliyuncs.com/IYXYZd.jpg' alt='IYXYZd'/>

### 分组排序

如果想让分组查询的结果按照某个特殊的字段进行升序或降序排列，那么应该怎么做呢？分组查询结果也支持排序功能，所需要用到的语句是 ORDER BY ，来看语句示例：

```sql
SELECT university, avg(active_days_within_30) as avg_active_days
FROM user_profile
GROUP BY university
ORDER BY avg_active_days
```

上述代码含义为按照学校分组分别计算每个学校用户的平均活跃天数情况，并按照平均活跃天数结果进行升序排列。

| university          | avg_active_days |
| ------------------- | --------------- |
| Zhejiang University | 5               |
| Peking University   | 9.5             |
| Fudan University    | 12              |
| Shandong University | 17.5            |

## Reference

1. [Understanding MySQL Storage Engines by mysqltutorial](https://www.mysqltutorial.org/understand-mysql-table-types-innodb-myisam.aspx)
